<!DOCTYPE html><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PhotoSheet Studio</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@300;400;500;600&display=swap');

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

:root {
  --ink: #1a1a2e;
  --paper: #f5f0e8;
  --accent: #c4692a;
  --accent2: #2a6bc4;
  --mid: #8a8a9a;
  --border: #d8d0c0;
  --white: #ffffff;
  --dark-bg: #2c2c3a;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

html, body {
  height: 100%; height: 100dvh;
  overflow: hidden;
  font-family: 'DM Sans', sans-serif;
  background: var(--dark-bg);
  color: var(--ink);
  -webkit-font-smoothing: antialiased;
}

.app-shell {
  display: flex;
  flex-direction: column;
  height: 100%;
  height: 100dvh;
}

/* TOP BAR */
.top-bar {
  background: var(--ink);
  color: white;
  display: flex;
  align-items: center;
  padding: 0 14px;
  height: 52px;
  flex-shrink: 0;
  border-bottom: 2px solid var(--accent);
  gap: 8px;
  position: relative;
  z-index: 100;
}
.top-bar .logo {
  font-family: 'Playfair Display', serif;
  font-size: 18px;
  flex: 1;
}
.top-bar .logo span { color: var(--accent); }
.top-actions { display: flex; gap: 6px; }

.icon-btn {
  background: rgba(255,255,255,0.1);
  border: none;
  color: white;
  width: 40px; height: 40px;
  border-radius: 10px;
  font-size: 17px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.15s;
  flex-shrink: 0;
}
.icon-btn:active { background: rgba(255,255,255,0.3); }
.icon-btn.accent { background: var(--accent); box-shadow: 0 2px 8px rgba(196,105,42,0.4); }
.icon-btn.accent:active { background: #b05a22; }
.icon-btn.success { background: #2a7a4c; }
.icon-btn.success:active { background: #1e5c38; }

/* CANVAS ZONE */
.canvas-zone {
  flex: 1;
  background: var(--dark-bg);
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding: 16px;
  position: relative;
}
.canvas-placeholder {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  color: rgba(255,255,255,0.22);
  text-align: center;
  pointer-events: none;
}
.canvas-placeholder .ph-icon { font-size: 52px; margin-bottom: 12px; }
.canvas-placeholder p { font-size: 15px; letter-spacing: 0.04em; }
.canvas-placeholder small { font-size: 12px; opacity: 0.6; margin-top: 5px; display: block; }

#canvas-wrapper {
  display: none;
  box-shadow: 0 8px 48px rgba(0,0,0,0.6);
  flex-shrink: 0;
  background: white;
}
#canvas-wrapper.visible { display: block; }
#main-canvas { display: block; }

/* FLOATING OBJECT TOOLBAR */
.obj-toolbar {
  position: fixed;
  bottom: calc(62px + var(--safe-bottom) + 10px);
  left: 50%;
  transform: translateX(-50%);
  background: rgba(18,18,30,0.96);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-radius: 16px;
  padding: 8px 10px;
  display: none;
  gap: 4px;
  align-items: center;
  border: 1px solid rgba(255,255,255,0.1);
  z-index: 200;
  white-space: nowrap;
  box-shadow: 0 4px 24px rgba(0,0,0,0.5);
}
.obj-toolbar.visible { display: flex; }
.otb-btn {
  background: rgba(255,255,255,0.1);
  border: none;
  color: white;
  padding: 9px 13px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  white-space: nowrap;
  transition: background 0.15s;
  min-width: 40px;
  text-align: center;
}
.otb-btn:active { background: rgba(255,255,255,0.28); }
.otb-btn.danger { color: #ff8080; }
.otb-sep { width: 1px; height: 22px; background: rgba(255,255,255,0.12); margin: 0 2px; }

/* BOTTOM NAV */
.bottom-nav {
  background: var(--ink);
  border-top: 1px solid rgba(255,255,255,0.07);
  display: flex;
  height: calc(62px + var(--safe-bottom));
  padding-bottom: var(--safe-bottom);
  flex-shrink: 0;
  z-index: 150;
}
.nav-tab {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 3px;
  border: none;
  background: transparent;
  color: rgba(255,255,255,0.38);
  font-size: 10px;
  font-family: 'DM Sans', sans-serif;
  font-weight: 500;
  letter-spacing: 0.04em;
  cursor: pointer;
  padding: 8px 4px;
  transition: color 0.15s;
}
.nav-tab .nav-icon { font-size: 21px; line-height: 1; }
.nav-tab.active { color: var(--accent); }
.nav-tab:active { color: white; }

/* OVERLAY */
.sheet-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 300;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.28s;
}
.sheet-overlay.open { opacity: 1; pointer-events: auto; }

/* BOTTOM SHEET */
.bottom-sheet {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: var(--white);
  border-radius: 22px 22px 0 0;
  z-index: 400;
  transform: translateY(100%);
  transition: transform 0.32s cubic-bezier(0.32,0.72,0,1);
  max-height: 90vh;
  max-height: 90dvh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 -8px 40px rgba(0,0,0,0.3);
}
.bottom-sheet.open { transform: translateY(0); }

.sheet-handle {
  width: 40px; height: 4px;
  background: var(--border);
  border-radius: 2px;
  margin: 12px auto 0;
  flex-shrink: 0;
}
.sheet-header {
  display: flex;
  align-items: center;
  padding: 14px 20px 12px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.sheet-header h2 {
  font-family: 'Playfair Display', serif;
  font-size: 17px;
  flex: 1;
}
.sheet-close {
  background: var(--paper);
  border: none;
  width: 34px; height: 34px;
  border-radius: 50%;
  font-size: 15px;
  cursor: pointer;
  color: var(--mid);
  display: flex; align-items: center; justify-content: center;
}
.sheet-body {
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  flex: 1;
  padding: 16px 18px;
  padding-bottom: calc(20px + var(--safe-bottom));
}

/* FORM */
.field-group { margin-bottom: 14px; }
label.field-label {
  display: block;
  font-size: 11px; font-weight: 600;
  color: var(--mid);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-bottom: 6px;
}
input[type="text"], input[type="number"], select {
  width: 100%;
  padding: 13px 14px;
  border: 1.5px solid var(--border);
  border-radius: 12px;
  font-family: 'DM Sans', sans-serif;
  font-size: 16px;
  color: var(--ink);
  background: var(--paper);
  outline: none;
  -webkit-appearance: none;
  transition: border-color 0.2s;
}
input:focus, select:focus { border-color: var(--accent2); }

.two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

.checkbox-row {
  display: flex; align-items: center; gap: 12px;
  padding: 10px 0;
}
.checkbox-row input[type="checkbox"] { accent-color: var(--accent); width: 22px; height: 22px; flex-shrink: 0; }
.checkbox-row label { font-size: 15px; line-height: 1.4; }

input[type="color"] {
  width: 50px; height: 46px;
  border: 1.5px solid var(--border);
  border-radius: 12px;
  padding: 3px; cursor: pointer;
  background: none; -webkit-appearance: none;
}
.color-row { display: flex; align-items: center; gap: 12px; padding: 6px 0; }
.color-row label { font-size: 15px; flex: 1; }

.range-label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.range-label-row span { font-size: 12px; color: var(--mid); }
.range-label-row strong { font-size: 14px; color: var(--ink); }
input[type="range"] { width: 100%; accent-color: var(--accent2); margin-bottom: 16px; height: 6px; }

.section-title {
  font-family: 'Playfair Display', serif;
  font-size: 12px; font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--mid);
  margin: 20px 0 12px;
}
.section-title:first-child { margin-top: 0; }

/* UPLOAD ZONE */
.upload-zone {
  border: 2.5px dashed var(--border);
  border-radius: 16px;
  padding: 28px 20px;
  text-align: center;
  cursor: pointer;
  background: var(--paper);
  position: relative;
  margin-bottom: 14px;
  transition: all 0.18s;
}
.upload-zone:active, .upload-zone.drag-over { border-color: var(--accent2); background: #eef4ff; }
.upload-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
.upload-zone .upload-icon { font-size: 38px; display: block; margin-bottom: 10px; }
.upload-zone p { font-size: 14px; color: var(--mid); line-height: 1.5; }
.upload-zone strong { color: var(--accent2); font-weight: 600; }

/* THUMBNAILS */
#thumbnail-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
.thumb-item {
  position: relative;
  border-radius: 10px;
  overflow: hidden;
  border: 2px solid var(--border);
  background: #eee;
}
.thumb-item img { width: 100%; aspect-ratio: 1; object-fit: cover; display: block; }
.thumb-item .thumb-remove {
  position: absolute; top: 4px; right: 4px;
  background: rgba(196,105,42,0.92);
  color: white; border: none;
  width: 26px; height: 26px;
  border-radius: 50%; font-size: 12px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}
.thumb-item .thumb-name {
  font-size: 9px; color: white;
  background: rgba(0,0,0,0.55);
  position: absolute; bottom: 0; left: 0; right: 0;
  padding: 3px 5px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* BUTTONS */
.big-btn {
  width: 100%;
  padding: 16px;
  border: none;
  border-radius: 14px;
  font-family: 'DM Sans', sans-serif;
  font-size: 17px; font-weight: 700;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  gap: 8px;
  margin-bottom: 10px;
  transition: all 0.18s;
}
.big-btn:active { transform: scale(0.97); }
.big-btn.primary { background: var(--accent); color: white; box-shadow: 0 4px 16px rgba(196,105,42,0.4); }
.big-btn.primary:active { background: #b05a22; }
.big-btn.success-btn { background: #2a7a4c; color: white; box-shadow: 0 4px 16px rgba(42,122,76,0.35); }
.big-btn.success-btn:active { background: #1e5c38; }

.action-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
.action-btn {
  padding: 14px 10px;
  background: var(--paper);
  color: var(--ink);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  font-family: 'DM Sans', sans-serif;
  font-size: 14px; font-weight: 600;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  gap: 6px;
  transition: all 0.15s;
}
.action-btn:active { background: #eef4ff; border-color: var(--accent2); }
.action-btn.danger { color: #c44040; border-color: #e0b0b0; }
.action-btn.danger:active { background: #fdf0f0; }

.hint-text { font-size: 12px; color: var(--mid); text-align: center; line-height: 1.5; margin-top: 8px; }

/* TOAST */
.toast {
  position: fixed;
  bottom: calc(74px + var(--safe-bottom));
  left: 50%;
  transform: translateX(-50%) translateY(16px);
  background: var(--ink);
  color: white;
  padding: 11px 20px;
  border-radius: 100px;
  font-size: 13px; font-weight: 600;
  border-left: 3px solid var(--accent);
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  opacity: 0;
  transition: all 0.25s;
  z-index: 9999;
  pointer-events: none;
  white-space: nowrap;
}
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* DESKTOP (â‰¥768px) â€” sidebar layout */
@media (min-width: 768px) {
  .app-shell { flex-direction: row; flex-wrap: wrap; height: 100vh; }
  .top-bar { width: 100%; order: -1; height: 56px; }

  .sidebar-desktop {
    width: 300px;
    background: var(--white);
    border-right: 1px solid var(--border);
    overflow-y: auto;
    order: 0;
    height: calc(100vh - 56px - 40px);
    display: flex;
    flex-direction: column;
  }

  .canvas-zone {
    flex: 1;
    order: 1;
    height: calc(100vh - 56px - 40px);
    padding: 28px;
  }

  .bottom-nav { display: none; }

  .obj-toolbar { bottom: calc(48px + 10px); }

  .sheet-overlay { display: none !important; }
  .bottom-sheet {
    position: static !important;
    transform: none !important;
    border-radius: 0;
    max-height: none;
    box-shadow: none;
    flex: 1;
    min-height: 0;
  }
  .bottom-sheet .sheet-handle,
  .bottom-sheet .sheet-header { display: none; }
  .bottom-sheet .sheet-body {
    padding: 14px 16px;
    padding-bottom: 16px;
  }
  .bottom-sheet .sheet-body .section-title:first-child { margin-top: 0; }

  .status-bar {
    display: flex !important;
    order: 2;
    width: 100%;
    height: 40px;
  }

  .toast { bottom: calc(48px + 10px); }
}

.status-bar {
  display: none;
  background: var(--ink);
  color: rgba(255,255,255,0.45);
  font-size: 11px;
  padding: 0 20px;
  align-items: center;
  gap: 20px;
  flex-shrink: 0;
  letter-spacing: 0.04em;
}
.status-bar span { color: rgba(255,255,255,0.8); }
</style>
</head>
<body>

<div class="app-shell">

  <header class="top-bar">
    <div class="logo">Photo<span>Sheet</span></div>
    <div class="top-actions">
      <button class="icon-btn accent" id="topGenerateBtn" title="Generate sheet" aria-label="Generate">âœ¦</button>
      <button class="icon-btn success" id="topDownloadBtn" title="Download JPEG" aria-label="Download" style="display:none">â¬‡</button>
    </div>
  </header>

  <!-- Desktop sidebar container (sheets moved here by JS) -->
  <div class="sidebar-desktop" id="sidebarDesktop"></div>

  <!-- Canvas -->
  <div class="canvas-zone" id="canvasArea">
    <div class="canvas-placeholder" id="canvasPlaceholder">
      <div class="ph-icon">ğŸ–¼</div>
      <p>Upload photos, then tap âœ¦ Generate</p>
      <small>Drag &amp; resize freely after generating</small>
    </div>
    <div id="canvas-wrapper">
      <canvas id="main-canvas"></canvas>
    </div>
  </div>

  <!-- Floating object toolbar -->
  <div class="obj-toolbar" id="objToolbar">
    <button class="otb-btn" id="otbFront">â†‘ Front</button>
    <button class="otb-btn" id="otbBack">â†“ Back</button>
    <div class="otb-sep"></div>
    <button class="otb-btn" id="otbFlipH">â†”</button>
    <button class="otb-btn" id="otbFlipV">â†•</button>
    <div class="otb-sep"></div>
    <button class="otb-btn danger" id="otbDelete">ğŸ—‘</button>
  </div>

  <!-- Status bar (desktop only) -->
  <div class="status-bar" id="statusBar">
    <span id="statusPhotos">0 photos</span>
    <span id="statusCanvas">No canvas</span>
    <span id="statusSelected">Nothing selected</span>
  </div>

  <!-- Bottom nav (mobile only) -->
  <nav class="bottom-nav">
    <button class="nav-tab active" data-sheet="photosSheet">
      <span class="nav-icon">ğŸ“·</span>Photos
    </button>
    <button class="nav-tab" data-sheet="settingsSheet">
      <span class="nav-icon">âš™ï¸</span>Settings
    </button>
    <button class="nav-tab" data-sheet="layoutSheet">
      <span class="nav-icon">ğŸ”²</span>Layout
    </button>
    <button class="nav-tab" data-sheet="actionsSheet">
      <span class="nav-icon">â–¶</span>Actions
    </button>
  </nav>

</div>

<!-- Overlay -->
<div class="sheet-overlay" id="sheetOverlay"></div>

<!-- SHEET: PHOTOS -->
<div class="bottom-sheet" id="photosSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <h2>ğŸ“· Photos</h2>
    <button class="sheet-close" data-close>âœ•</button>
  </div>
  <div class="sheet-body">
    <div class="upload-zone" id="uploadZone">
      <input type="file" id="photoInput" multiple accept="image/*">
      <span class="upload-icon">ğŸ“</span>
      <p><strong>Tap to upload</strong> or use camera<br>JPG, PNG, WEBP</p>
    </div>
    <div id="thumbnail-list"></div>
  </div>
</div>

<!-- SHEET: SETTINGS -->
<div class="bottom-sheet" id="settingsSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <h2>âš™ï¸ Settings</h2>
    <button class="sheet-close" data-close>âœ•</button>
  </div>
  <div class="sheet-body">
    <p class="section-title">School Details</p>
    <div class="field-group">
      <label class="field-label">School Name</label>
      <input type="text" id="schoolName" value="Springfield Elementary" autocomplete="off">
    </div>
    <div class="field-group">
      <label class="field-label">Class / Grade</label>
      <input type="text" id="className" value="Grade 5 â€“ Class A" autocomplete="off">
    </div>
    <div class="field-group">
      <label class="field-label">Year / Term</label>
      <input type="text" id="yearTerm" value="2024â€“2025" autocomplete="off">
    </div>
    <div class="checkbox-row">
      <input type="checkbox" id="lockHeader" checked>
      <label for="lockHeader">Lock header (prevent accidental moves)</label>
    </div>

    <p class="section-title">Page Setup</p>
    <div class="field-group">
      <label class="field-label">Page Size</label>
      <select id="pageSize">
        <option value="a4">A4 (210 Ã— 297 mm)</option>
        <option value="letter">US Letter (216 Ã— 279 mm)</option>
        <option value="a3">A3 (297 Ã— 420 mm)</option>
        <option value="square">Square (297 Ã— 297 mm)</option>
      </select>
    </div>
    <div class="field-group">
      <label class="field-label">Orientation</label>
      <select id="pageOrientation">
        <option value="portrait">Portrait</option>
        <option value="landscape">Landscape</option>
      </select>
    </div>

    <div class="range-label-row">
      <span>Export Quality (DPI)</span>
      <strong id="dpiVal">150</strong>
    </div>
    <input type="range" id="dpiSlider" min="72" max="300" step="36" value="150">

    <div class="color-row">
      <label>Background colour</label>
      <input type="color" id="bgColor" value="#ffffff">
    </div>
  </div>
</div>

<!-- SHEET: LAYOUT -->
<div class="bottom-sheet" id="layoutSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <h2>ğŸ”² Layout</h2>
    <button class="sheet-close" data-close>âœ•</button>
  </div>
  <div class="sheet-body">
    <p class="section-title">Grid</p>
    <div class="two-col">
      <div class="field-group">
        <label class="field-label">Columns</label>
        <input type="number" id="cols" value="4" min="1" max="10" inputmode="numeric">
      </div>
      <div class="field-group">
        <label class="field-label">Rows</label>
        <input type="number" id="rows" value="5" min="1" max="12" inputmode="numeric">
      </div>
    </div>

    <div class="range-label-row">
      <span>Photo padding</span>
      <strong><span id="paddingVal">10</span>px</strong>
    </div>
    <input type="range" id="paddingSlider" min="0" max="30" value="10">
  </div>
</div>

<!-- SHEET: ACTIONS -->
<div class="bottom-sheet" id="actionsSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <h2>â–¶ Actions</h2>
    <button class="sheet-close" data-close>âœ•</button>
  </div>
  <div class="sheet-body">
    <button class="big-btn primary" id="generateBtn">âœ¦ Generate Photo Sheet</button>
    <div class="action-row">
      <button class="action-btn" id="shuffleBtn">ğŸ”€ Shuffle</button>
      <button class="action-btn danger" id="clearCanvasBtn">ğŸ—‘ Clear All</button>
    </div>
    <button class="big-btn success-btn" id="downloadBtn" style="display:none">â¬‡ Download JPEG</button>
    <p class="hint-text">After generating, tap a photo to select it â€” then drag to move or use corner handles to resize.</p>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function() {
  const $ = id => document.getElementById(id);
  let canvas = null, photoFiles = [], photoOrder = [];

  // â”€â”€ Responsive: move sheets to sidebar on desktop â”€â”€â”€â”€â”€â”€
  function doLayout() {
    const isDesk = window.innerWidth >= 768;
    const sidebar = $('sidebarDesktop');
    ['photosSheet','settingsSheet','layoutSheet','actionsSheet'].forEach(id => {
      const el = $(id);
      if (isDesk) {
        if (el.parentNode !== sidebar) sidebar.appendChild(el);
        el.classList.add('open');
      } else {
        if (el.parentNode !== document.body) document.body.appendChild(el);
      }
    });
  }
  doLayout();
  window.addEventListener('resize', doLayout);

  // â”€â”€ Bottom sheets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let activeSheet = null;

  function openSheet(id) {
    if (window.innerWidth >= 768) return;
    if (activeSheet && activeSheet !== id) {
      $(activeSheet).classList.remove('open');
    }
    const el = $(id);
    el.classList.add('open');
    $('sheetOverlay').classList.add('open');
    activeSheet = id;
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.toggle('active', t.dataset.sheet === id));
  }

  function closeSheet() {
    if (!activeSheet || window.innerWidth >= 768) return;
    $(activeSheet).classList.remove('open');
    $('sheetOverlay').classList.remove('open');
    activeSheet = null;
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  }

  $('sheetOverlay').addEventListener('click', closeSheet);
  document.querySelectorAll('[data-close]').forEach(b => b.addEventListener('click', closeSheet));
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      if (activeSheet === tab.dataset.sheet) closeSheet();
      else openSheet(tab.dataset.sheet);
    });
  });

  // Swipe down to close sheet
  let swipeStartY = 0;
  document.querySelectorAll('.bottom-sheet').forEach(sheet => {
    sheet.addEventListener('touchstart', e => { swipeStartY = e.touches[0].clientY; }, { passive: true });
    sheet.addEventListener('touchend', e => {
      if (e.changedTouches[0].clientY - swipeStartY > 65) closeSheet();
    }, { passive: true });
  });

  // â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toast(msg, dur = 2800) {
    const el = $('toast');
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(el._t);
    el._t = setTimeout(() => el.classList.remove('show'), dur);
  }

  // â”€â”€ File upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $('photoInput').addEventListener('change', e => handleFiles(e.target.files));
  const uZone = $('uploadZone');
  uZone.addEventListener('dragover', e => { e.preventDefault(); uZone.classList.add('drag-over'); });
  uZone.addEventListener('dragleave', () => uZone.classList.remove('drag-over'));
  uZone.addEventListener('drop', e => { e.preventDefault(); uZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });

  function handleFiles(files) {
    const arr = Array.from(files).filter(f => f.type.startsWith('image/'));
    arr.forEach(f => { photoFiles.push(f); photoOrder.push(photoFiles.length - 1); });
    renderThumbs(); updateStatus();
    toast(`${arr.length} photo(s) added`);
  }

  function renderThumbs() {
    const list = $('thumbnail-list');
    list.innerHTML = '';
    photoOrder.forEach((idx, pos) => {
      const f = photoFiles[idx];
      const url = URL.createObjectURL(f);
      const div = document.createElement('div');
      div.className = 'thumb-item';
      div.draggable = true;
      div.dataset.pos = pos;
      const img = document.createElement('img');
      img.src = url;
      img.onload = () => URL.revokeObjectURL(url);
      const name = document.createElement('div');
      name.className = 'thumb-name';
      name.textContent = f.name.replace(/\.[^.]+$/, '');
      const rm = document.createElement('button');
      rm.className = 'thumb-remove';
      rm.innerHTML = 'âœ•';
      rm.addEventListener('click', e => { e.stopPropagation(); photoOrder.splice(pos, 1); renderThumbs(); updateStatus(); });
      div.append(img, name, rm);
      list.appendChild(div);
      div.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', pos); div.classList.add('dragging'); });
      div.addEventListener('dragend', () => div.classList.remove('dragging'));
      div.addEventListener('dragover', e => e.preventDefault());
      div.addEventListener('drop', e => {
        e.preventDefault();
        const from = +e.dataTransfer.getData('text/plain'), to = pos;
        if (from !== to) { const t = photoOrder[from]; photoOrder.splice(from,1); photoOrder.splice(to,0,t); renderThumbs(); }
      });
    });
  }

  // â”€â”€ Sliders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $('dpiSlider').addEventListener('input', function(){ $('dpiVal').textContent = this.value; });
  $('paddingSlider').addEventListener('input', function(){ $('paddingVal').textContent = this.value; });
  $('bgColor').addEventListener('input', function(){ if (canvas){ canvas.backgroundColor = this.value; canvas.renderAll(); }});

  // â”€â”€ Page size â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const PAGE_SIZES = { a4:[210,297], letter:[216,279], a3:[297,420], square:[297,297] };
  function getPagePx() {
    const dpi = +$('dpiSlider').value, s = PAGE_SIZES[$('pageSize').value];
    let [w,h] = s;
    if ($('pageOrientation').value === 'landscape') [w,h] = [h,w];
    const mm = dpi / 25.4;
    return [Math.round(w*mm), Math.round(h*mm)];
  }

  // â”€â”€ Generate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function generateSheet() {
    if (!photoFiles.length) { toast('Upload photos first!'); openSheet('photosSheet'); return; }
    if (window.innerWidth < 768) closeSheet();

    const [W, H] = getPagePx();
    const cols = Math.max(1, +$('cols').value || 4);
    const rows = Math.max(1, +$('rows').value || 5);
    const pad = +$('paddingSlider').value;
    const locked = $('lockHeader').checked;

    $('canvas-wrapper').classList.add('visible');
    $('canvasPlaceholder').style.display = 'none';

    if (canvas) {
      canvas.dispose();
      const old = $('main-canvas');
      if (old) old.remove();
    }
    const c = document.createElement('canvas');
    c.id = 'main-canvas';
    $('canvas-wrapper').appendChild(c);

    const area = $('canvasArea');
    const maxW = area.clientWidth - 32, maxH = area.clientHeight - 32;
    const scale = Math.min(1, maxW/W, maxH/H);

    canvas = new fabric.Canvas('main-canvas', {
      width: W, height: H,
      backgroundColor: $('bgColor').value,
      selection: true,
      preserveObjectStacking: true,
      allowTouchScrolling: false,
    });
    canvas.setZoom(scale);
    canvas.setWidth(W * scale);
    canvas.setHeight(H * scale);
    $('canvas-wrapper').style.cssText = `width:${W*scale}px;height:${H*scale}px;`;

    // Header
    const hh = H * 0.09;
    canvas.add(
      new fabric.Rect({ left:0,top:0,width:W,height:hh,fill:'#1a1a2e',
        selectable:!locked,evented:!locked,lockMovementX:locked,lockMovementY:locked,hasControls:!locked,hasBorders:!locked }),
      new fabric.Text($('schoolName').value||'School', { left:W/2,top:hh*0.22,originX:'center',
        fontFamily:'Georgia,serif',fontSize:Math.round(hh*0.32),fill:'#fff',fontWeight:'bold',
        selectable:!locked,evented:!locked,lockMovementX:locked,lockMovementY:locked,hasControls:!locked }),
      new fabric.Text(($('className').value||'Class')+' â€¢ '+($('yearTerm').value||''), {
        left:W/2,top:hh*0.62,originX:'center',fontFamily:'Georgia,serif',fontSize:Math.round(hh*0.18),fill:'rgba(255,255,255,0.7)',
        selectable:!locked,evented:!locked,lockMovementX:locked,lockMovementY:locked,hasControls:!locked }),
      new fabric.Rect({ left:0,top:hh-4,width:W,height:4,fill:'#c4692a',selectable:false,evented:false })
    );

    // Grid
    const gridTop = hh + pad*2, gridH = H - gridTop - pad, gridW = W - pad*2;
    const cellW = (gridW - pad*(cols-1)) / cols;
    const cellH = (gridH - pad*(rows-1)) / rows;
    const isMobile = window.innerWidth < 768;
    const cornerSz = isMobile ? 20 : 11;

    const loadImg = f => new Promise(res => {
      const url = URL.createObjectURL(f);
      fabric.Image.fromURL(url, img => { URL.revokeObjectURL(url); res(img); }, { crossOrigin:'anonymous' });
    });

    for (let i = 0; i < Math.min(photoOrder.length, cols*rows); i++) {
      const img = await loadImg(photoFiles[photoOrder[i]]);
      const col = i%cols, row = Math.floor(i/cols);
      const x = pad + col*(cellW+pad), y = gridTop + row*(cellH+pad);
      const iw = img.width, ih = img.height;
      const sc = Math.min(cellW/iw, cellH/ih);
      img.set({
        left: x + (cellW-iw*sc)/2,
        top:  y + (cellH-ih*sc)/2,
        scaleX: sc, scaleY: sc,
        lockUniScaling: true,
        cornerSize: cornerSz,
        touchCornerSize: 28,
        transparentCorners: false,
        cornerColor: '#2a6bc4', cornerStrokeColor: '#fff',
        borderColor: '#2a6bc4', borderScaleFactor: 2,
      });
      canvas.add(img);
    }

    canvas.renderAll();
    setupCanvasEvents();
    $('topDownloadBtn').style.display = 'flex';
    $('downloadBtn').style.display = 'flex';
    updateStatus();
    toast('âœ¦ Generated! Tap a photo to select & edit.');
  }

  $('generateBtn').addEventListener('click', generateSheet);
  $('topGenerateBtn').addEventListener('click', generateSheet);

  // â”€â”€ Canvas events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setupCanvasEvents() {
    canvas.on('selection:created', onSel);
    canvas.on('selection:updated', onSel);
    canvas.on('selection:cleared', () => {
      $('objToolbar').classList.remove('visible');
      $('statusSelected').textContent = 'Nothing selected';
    });
  }

  function onSel() {
    const o = canvas.getActiveObject();
    if (!o) return;
    $('objToolbar').classList.add('visible');
    $('statusSelected').textContent = `Selected (${Math.round(o.getScaledWidth())}Ã—${Math.round(o.getScaledHeight())}px)`;
  }

  $('otbDelete').addEventListener('click', () => { const o = canvas?.getActiveObject(); if(o){ canvas.remove(o); canvas.renderAll(); $('objToolbar').classList.remove('visible'); toast('Deleted'); }});
  $('otbFront').addEventListener('click', () => { const o = canvas?.getActiveObject(); if(o){ canvas.bringToFront(o); canvas.renderAll(); }});
  $('otbBack').addEventListener('click', () => { const o = canvas?.getActiveObject(); if(o){ canvas.sendToBack(o); canvas.renderAll(); }});
  $('otbFlipH').addEventListener('click', () => { const o = canvas?.getActiveObject(); if(o){ o.set('flipX',!o.flipX); canvas.renderAll(); }});
  $('otbFlipV').addEventListener('click', () => { const o = canvas?.getActiveObject(); if(o){ o.set('flipY',!o.flipY); canvas.renderAll(); }});

  // â”€â”€ Shuffle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $('shuffleBtn').addEventListener('click', () => {
    for (let i = photoOrder.length-1; i>0; i--) { const j = Math.floor(Math.random()*(i+1)); [photoOrder[i],photoOrder[j]]=[photoOrder[j],photoOrder[i]]; }
    renderThumbs();
    if (canvas) generateSheet();
    toast('ğŸ”€ Shuffled!');
  });

  // â”€â”€ Clear â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $('clearCanvasBtn').addEventListener('click', () => {
    if (canvas) { canvas.dispose(); canvas = null; const old=$('main-canvas'); if(old) old.remove(); const c=document.createElement('canvas'); c.id='main-canvas'; $('canvas-wrapper').appendChild(c); $('canvas-wrapper').classList.remove('visible'); }
    $('canvasPlaceholder').style.display = '';
    $('objToolbar').classList.remove('visible');
    $('topDownloadBtn').style.display = 'none';
    $('downloadBtn').style.display = 'none';
    photoFiles=[]; photoOrder=[];
    renderThumbs(); updateStatus(); toast('Cleared');
  });

  // â”€â”€ Download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function doDownload() {
    if (!canvas) return;
    const [W,H] = getPagePx();
    // Export at full res
    canvas.setZoom(1); canvas.setWidth(W); canvas.setHeight(H); canvas.renderAll();
    const dataURL = canvas.toDataURL({ format:'jpeg', quality:0.94 });
    // Restore zoom
    const maxW = $('canvasArea').clientWidth-32, maxH = $('canvasArea').clientHeight-32;
    const scale = Math.min(1, maxW/W, maxH/H);
    canvas.setZoom(scale); canvas.setWidth(W*scale); canvas.setHeight(H*scale); canvas.renderAll();

    const isMobile = /Mobi|Android/i.test(navigator.userAgent);
    if (isMobile) {
      // Mobile: open image in new tab â€” user long-presses to save
      const win = window.open('', '_blank');
      if (win) {
        win.document.write(`<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width,initial-scale=1"><title>Photo Sheet</title><style>body{margin:0;background:#111;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:16px;gap:12px;font-family:sans-serif;}img{max-width:100%;border-radius:6px;box-shadow:0 4px 20px rgba(0,0,0,0.5);}p{color:#aaa;font-size:13px;text-align:center;}</style></head><body><img src="${dataURL}"><p>ğŸ“² Long-press the image â†’ <strong style="color:#fff">Save to Photos</strong></p></body></html>`);
        toast('ğŸ“² Long-press the image to save');
      } else {
        toast('Enable pop-ups to download');
      }
    } else {
      const a = document.createElement('a');
      a.download = ($('schoolName').value||'photosheet').replace(/\s+/g,'_') + '.jpg';
      a.href = dataURL; a.click();
      toast('â¬‡ Downloadingâ€¦');
    }
  }

  $('downloadBtn').addEventListener('click', doDownload);
  $('topDownloadBtn').addEventListener('click', doDownload);

  // â”€â”€ Keyboard shortcuts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.addEventListener('keydown', e => {
    if (!canvas) return;
    if ((e.key==='Delete'||e.key==='Backspace') && !e.target.matches('input,textarea,select')) {
      const o = canvas.getActiveObject();
      if (o) { canvas.remove(o); canvas.renderAll(); }
    }
  });

  // â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateStatus() {
    $('statusPhotos').textContent = `${photoFiles.length} photo(s)`;
    $('statusCanvas').textContent = canvas ? (() => { const [W,H]=getPagePx(); return `${W}Ã—${H}px`; })() : 'No canvas';
  }

  updateStatus();
})();
</script>
</body>
</html>
