<!DOCTYPE html><!DOCTYPE html><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Samsidh Frame Lab</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@300;400;500;600;700&display=swap');

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}

:root{
  --brand:#C2187E;
  --brand-d:#9E1268;
  --brand-bg:#FDF0F7;
  --green:#16A34A;
  --ink:#111;
  --ink-2:#555;
  --ink-3:#999;
  --border:#E8E8E8;
  --surface:#FAFAFA;
  --white:#fff;
  --dark:#0F0F0F;
  --safe-b:env(safe-area-inset-bottom,0px);
  --safe-t:env(safe-area-inset-top,0px);
}

html,body{
  height:100%;height:100dvh;
  overflow:hidden;
  font-family:'DM Sans',sans-serif;
  background:var(--dark);
  color:var(--ink);
  -webkit-font-smoothing:antialiased;
}

/* â”€â”€ TOP CHROME â”€â”€ */
.chrome{
  position:fixed;top:0;left:0;right:0;
  z-index:100;
  background:rgba(10,10,10,0.85);
  backdrop-filter:blur(20px);
  -webkit-backdrop-filter:blur(20px);
  border-bottom:1px solid rgba(255,255,255,0.07);
  padding-top:var(--safe-t);
}
.chrome-inner{
  display:flex;align-items:center;gap:12px;
  height:52px;padding:0 20px;
}
.chrome-logo{
  display:flex;align-items:center;gap:7px;flex:1;
}
.logo-s{
  font-family:'Playfair Display',serif;
  font-size:19px;font-weight:700;
  color:var(--brand);letter-spacing:-0.01em;
}
.logo-pipe{width:1px;height:14px;background:#444;flex-shrink:0}
.logo-fl{
  font-size:11px;font-weight:600;
  color:rgba(255,255,255,0.4);
  letter-spacing:0.1em;text-transform:uppercase;
}

/* STEP PROGRESS DOTS */
.step-dots{
  display:flex;align-items:center;gap:6px;
}
.step-dot{
  width:8px;height:8px;border-radius:50%;
  background:rgba(255,255,255,0.15);
  transition:all 0.35s cubic-bezier(.4,0,.2,1);
  flex-shrink:0;
}
.step-dot.active{
  width:24px;border-radius:4px;
  background:var(--brand);
}
.step-dot.done{background:var(--green);}

/* CHROME ACTIONS */
.chrome-acts{display:flex;gap:6px;align-items:center}
.dl-chip{
  background:var(--green);color:#fff;
  border:none;border-radius:20px;
  padding:0 14px;height:34px;
  font-family:'DM Sans',sans-serif;
  font-size:13px;font-weight:700;
  cursor:pointer;display:flex;align-items:center;gap:5px;
  display:none;
  transition:all .15s;
}
.dl-chip:active{background:#15803D;transform:scale(.96)}

/* â”€â”€ WIZARD VIEWPORT â”€â”€ */
.wizard-vp{
  position:fixed;
  top:52px;left:0;right:0;
  bottom:0;
  overflow:hidden;
  /* shown only when canvas not visible */
}
.wizard-vp.hidden{display:none}

.slides-track{
  display:flex;
  width:500%;/* 5 slides */
  height:100%;
  transition:transform 0.45s cubic-bezier(0.77,0,0.18,1);
  will-change:transform;
}
.slide{
  width:20%;/* each slide = 100vw */
  height:100%;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  background:var(--white);
  display:flex;flex-direction:column;
  flex-shrink:0;
}

/* â”€â”€ SLIDE CONTENT â”€â”€ */
.slide-inner{
  flex:1;
  padding:36px 28px 0;
  display:flex;flex-direction:column;
}

.slide-eyebrow{
  font-size:11px;font-weight:700;
  color:var(--brand);
  letter-spacing:0.12em;text-transform:uppercase;
  margin-bottom:10px;
}
.slide-title{
  font-family:'Playfair Display',serif;
  font-size:28px;font-weight:700;
  color:var(--ink);line-height:1.2;
  margin-bottom:8px;
}
.slide-sub{
  font-size:14px;color:var(--ink-2);
  line-height:1.6;margin-bottom:28px;
}

/* â”€â”€ SLIDE 0: WELCOME â”€â”€ */
.welcome-flower{
  font-size:56px;
  display:block;
  margin-bottom:20px;
  animation:floatIn .6s ease both;
}
@keyframes floatIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

.welcome-steps{
  display:flex;flex-direction:column;gap:12px;
  margin-bottom:32px;
}
.wstep{
  display:flex;align-items:flex-start;gap:12px;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px 16px;
}
.wstep-num{
  width:28px;height:28px;border-radius:50%;
  background:var(--brand-bg);
  color:var(--brand);
  font-size:13px;font-weight:700;
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;
}
.wstep-text strong{display:block;font-size:14px;font-weight:600;color:var(--ink);margin-bottom:2px}
.wstep-text span{font-size:12px;color:var(--ink-3)}

/* â”€â”€ GRID SELECTOR (slide 1) â”€â”€ */
.grid-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px}
.gf label{display:block;font-size:11px;font-weight:700;color:var(--ink-3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px}
.gf input{
  width:100%;padding:16px;
  border:1.5px solid var(--border);border-radius:14px;
  font-family:'DM Sans',sans-serif;font-size:28px;font-weight:700;
  color:var(--ink);background:#fff;
  text-align:center;outline:none;
  -webkit-appearance:none;
  transition:border-color .2s,box-shadow .2s;
}
.gf input:focus{border-color:var(--brand);box-shadow:0 0 0 4px rgba(194,24,126,.08)}

.slot-pill{
  display:inline-flex;align-items:center;gap:8px;
  background:var(--brand-bg);border:1px solid rgba(194,24,126,.2);
  color:var(--brand);
  font-size:13px;font-weight:600;
  padding:10px 16px;border-radius:100px;
}

/* â”€â”€ PHOTO GRID (slide 2) â”€â”€ */
.upload-big{
  border:2px dashed var(--border);
  border-radius:18px;padding:28px 20px;
  text-align:center;cursor:pointer;
  background:var(--surface);
  position:relative;transition:all .2s;
  margin-bottom:16px;
}
.upload-big:active,.upload-big.over{border-color:var(--brand);background:var(--brand-bg)}
.upload-big input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.upload-big .ub-icon{font-size:32px;display:block;margin-bottom:8px}
.upload-big p{font-size:14px;color:var(--ink-2);line-height:1.5}
.upload-big strong{color:var(--brand)}

.photo-count-bar{
  font-size:12px;color:var(--ink-3);font-weight:500;
  text-align:center;margin-bottom:12px;
  display:none;
}
.photo-count-bar.full{color:#DC2626}

.photo-grid{display:grid;gap:6px}
.pcell{
  position:relative;border-radius:10px;overflow:hidden;
  border:1.5px solid var(--border);background:#F0F0F0;
  aspect-ratio:1;cursor:pointer;
}
.pcell img{width:100%;height:100%;object-fit:cover;display:block;pointer-events:none}
.pcell .pnum{
  position:absolute;top:4px;left:4px;
  background:rgba(0,0,0,.55);color:#fff;
  font-size:9px;font-weight:700;
  width:18px;height:18px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
}
.pcell .pdel{
  position:absolute;top:4px;right:4px;
  background:rgba(194,24,126,.85);color:#fff;
  border:none;width:22px;height:22px;border-radius:50%;
  font-size:10px;font-weight:700;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}
.pcell.empty{
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;background:#F9F9F9;border-style:dashed;
}
.pcell.empty input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.pcell.empty .elabel{font-size:10px;color:var(--ink-3);text-align:center;line-height:1.4;pointer-events:none}
.pcell .crop-tag{
  position:absolute;bottom:4px;left:4px;right:4px;
  background:rgba(0,0,0,.55);
  color:#fff;font-size:9px;font-weight:600;
  text-align:center;border-radius:4px;padding:2px 0;
  cursor:pointer;
}

/* â”€â”€ DETAILS FORM (slide 3) â”€â”€ */
.df{margin-bottom:14px}
.df label{display:block;font-size:11px;font-weight:700;color:var(--ink-3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px}
.df input,.df select{
  width:100%;padding:14px 16px;
  border:1.5px solid var(--border);border-radius:14px;
  font-family:'DM Sans',sans-serif;font-size:16px;
  color:var(--ink);background:#fff;outline:none;
  -webkit-appearance:none;
  transition:border-color .2s,box-shadow .2s;
}
.df input:focus,.df select:focus{border-color:var(--brand);box-shadow:0 0 0 4px rgba(194,24,126,.08)}
.df-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* â”€â”€ SLIDE FOOTER (nav buttons) â”€â”€ */
.slide-footer{
  padding:20px 28px;
  padding-bottom:calc(24px + var(--safe-b));
  flex-shrink:0;
  display:flex;flex-direction:column;gap:10px;
}

.btn-next{
  width:100%;padding:17px;
  background:var(--brand);color:#fff;
  border:none;border-radius:16px;
  font-family:'DM Sans',sans-serif;
  font-size:16px;font-weight:700;
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:8px;
  transition:all .15s;
  box-shadow:0 4px 20px rgba(194,24,126,.3);
  letter-spacing:.01em;
}
.btn-next:active{background:var(--brand-d);transform:scale(.97);box-shadow:none}
.btn-next:disabled{background:#DDD;color:#AAA;box-shadow:none;cursor:not-allowed}

.btn-prev{
  width:100%;padding:14px;
  background:transparent;color:var(--ink-2);
  border:1.5px solid var(--border);border-radius:16px;
  font-family:'DM Sans',sans-serif;
  font-size:15px;font-weight:600;
  cursor:pointer;
  transition:all .15s;
}
.btn-prev:active{background:var(--surface)}

.btn-gen{
  width:100%;padding:17px;
  background:var(--brand);color:#fff;
  border:none;border-radius:16px;
  font-family:'DM Sans',sans-serif;
  font-size:16px;font-weight:700;
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:8px;
  transition:all .15s;
  box-shadow:0 4px 20px rgba(194,24,126,.3);
}
.btn-gen:active{background:var(--brand-d);transform:scale(.97);box-shadow:none}

.btn-dl{
  width:100%;padding:17px;
  background:var(--green);color:#fff;
  border:none;border-radius:16px;
  font-family:'DM Sans',sans-serif;
  font-size:16px;font-weight:700;
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:8px;
  transition:all .15s;
  box-shadow:0 4px 16px rgba(22,163,74,.3);
  display:none;
}
.btn-dl:active{background:#15803D;transform:scale(.97)}

/* â”€â”€ CANVAS SLIDE (slide 4) â”€â”€ */
.slide.canvas-slide{
  background:var(--dark);
  overflow:hidden;
}
.canvas-zone{
  flex:1;overflow:auto;
  -webkit-overflow-scrolling:touch;
  display:flex;align-items:flex-start;
  justify-content:center;
  padding:20px;
  background:var(--dark);
  background-image:radial-gradient(circle,rgba(194,24,126,.08) 1px,transparent 1px);
  background-size:22px 22px;
}
#canvas-wrapper{
  display:none;
  box-shadow:0 20px 80px rgba(0,0,0,.8),0 0 0 1px rgba(255,255,255,.06);
  flex-shrink:0;background:#fff;border-radius:2px;
}
#canvas-wrapper.visible{display:block}
#main-canvas{display:block}

.canvas-placeholder{
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  text-align:center;flex:1;gap:10px;
  pointer-events:none;
}
.canvas-placeholder .cp-icon{font-size:48px;opacity:.2}
.canvas-placeholder .cp-title{font-size:15px;font-weight:500;color:rgba(255,255,255,.2)}
.canvas-placeholder .cp-sub{font-size:12px;color:rgba(255,255,255,.12)}

/* FLOATING OBJECT TOOLBAR */
.obj-tb{
  position:fixed;
  bottom:calc(var(--safe-b) + 20px);
  left:50%;transform:translateX(-50%);
  background:rgba(20,20,20,.97);
  backdrop-filter:blur(20px);
  -webkit-backdrop-filter:blur(20px);
  border-radius:12px;padding:5px;
  display:none;gap:2px;align-items:center;
  border:1px solid #333;z-index:500;
  white-space:nowrap;
  box-shadow:0 8px 32px rgba(0,0,0,.7);
}
.obj-tb.on{display:flex}
.ot-btn{
  background:transparent;border:none;
  color:#CCC;padding:7px 11px;
  border-radius:8px;font-size:12px;font-weight:500;
  cursor:pointer;font-family:'DM Sans',sans-serif;
  white-space:nowrap;
  transition:background .12s,color .12s;
}
.ot-btn:hover,.ot-btn:active{background:#2A2A2A;color:#fff}
.ot-btn.red{color:#F87171}
.ot-btn.red:active{background:rgba(248,113,113,.15)}
.ot-sep{width:1px;height:16px;background:#333;margin:0 1px}

/* â”€â”€ CROP MODAL â”€â”€ */
.crop-modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.88);
  z-index:1000;display:none;
  align-items:center;justify-content:center;padding:20px;
}
.crop-modal.on{display:flex}
.crop-box{
  background:#1C1C1C;border-radius:20px;
  max-width:460px;width:100%;
  box-shadow:0 24px 80px rgba(0,0,0,.9);
  overflow:hidden;
}
.crop-hdr{
  display:flex;align-items:center;padding:16px 18px;
  border-bottom:1px solid #2A2A2A;
}
.crop-hdr h3{flex:1;font-size:15px;font-weight:600;color:#EEE}
.crop-x{
  background:#2A2A2A;border:none;color:#888;
  width:28px;height:28px;border-radius:50%;
  cursor:pointer;font-size:14px;
  display:flex;align-items:center;justify-content:center;
  font-weight:700;
}
.crop-preview{
  background:#000;display:flex;
  align-items:center;justify-content:center;
  padding:12px;min-height:200px;
}
#crop-canvas{display:block;max-width:100%;border-radius:6px}
.crop-ctrls{padding:14px 18px;display:flex;flex-direction:column;gap:10px}
.cr-row{display:flex;align-items:center;gap:10px}
.cr-lbl{font-size:11px;color:#888;min-width:52px;font-weight:600;text-transform:uppercase;letter-spacing:.05em}
.cr-sl{flex:1;accent-color:var(--brand);height:4px;cursor:pointer}
.cr-val{font-size:11px;color:var(--brand);min-width:28px;text-align:right;font-weight:700}
.crop-acts{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 18px 18px}
.crop-acts button{padding:12px;border-radius:12px;border:none;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .15s}
.ca-ok{background:var(--brand);color:#fff}
.ca-ok:active{background:var(--brand-d)}
.ca-no{background:#2A2A2A;color:#CCC}
.ca-no:active{background:#333}

/* TOAST */
.toast{
  position:fixed;
  bottom:calc(24px + var(--safe-b));
  left:50%;transform:translateX(-50%) translateY(16px);
  background:#111;color:#EEE;
  padding:10px 18px;border-radius:100px;
  font-size:13px;font-weight:500;
  border:1px solid #2A2A2A;
  box-shadow:0 4px 20px rgba(0,0,0,.6);
  opacity:0;transition:all .22s;
  z-index:9999;pointer-events:none;
  white-space:nowrap;
}
.toast.on{transform:translateX(-50%) translateY(0);opacity:1}

/* BACK BUTTON IN CANVAS SLIDE */
.canvas-back{
  background:rgba(255,255,255,.1);
  border:1px solid rgba(255,255,255,.15);
  color:rgba(255,255,255,.7);
  border-radius:100px;
  padding:0 14px;height:34px;
  font-family:'DM Sans',sans-serif;
  font-size:12px;font-weight:600;
  cursor:pointer;display:flex;align-items:center;gap:5px;
  letter-spacing:.02em;
  transition:all .15s;
}
.canvas-back:active{background:rgba(255,255,255,.2)}

/* SCROLLBAR HIDE */
.slide::-webkit-scrollbar{display:none}
.slide{-ms-overflow-style:none;scrollbar-width:none}
</style>
</head>
<body>

<!-- CHROME TOP BAR -->
<div class="chrome">
  <div class="chrome-inner">
    <div class="chrome-logo">
      <span class="logo-s">Samsidh</span>
      <div class="logo-pipe"></div>
      <span class="logo-fl">Frame Lab</span>
    </div>
    <div class="step-dots" id="stepDots">
      <div class="step-dot active" data-i="0"></div>
      <div class="step-dot" data-i="1"></div>
      <div class="step-dot" data-i="2"></div>
      <div class="step-dot" data-i="3"></div>
      <div class="step-dot" data-i="4"></div>
    </div>
    <div class="chrome-acts">
      <button class="canvas-back" id="backToWizard" style="display:none">â† Edit</button>
      <button class="dl-chip" id="topDl">â¬‡ Download</button>
    </div>
  </div>
</div>

<!-- WIZARD VIEWPORT -->
<div class="wizard-vp" id="wizardVp">
  <div class="slides-track" id="track">

    <!-- SLIDE 0: WELCOME -->
    <div class="slide" id="s0">
      <div class="slide-inner">
        <span class="welcome-flower">ğŸª·</span>
        <div class="slide-eyebrow">Welcome</div>
        <div class="slide-title">Let's build your<br>frame sheet.</div>
        <div class="slide-sub">Create a professional Samsidh photo sheet in just a few simple steps.</div>

        <div class="welcome-steps">
          <div class="wstep">
            <div class="wstep-num">1</div>
            <div class="wstep-text">
              <strong>Set Grid</strong>
              <span>Choose how many columns &amp; rows of photos</span>
            </div>
          </div>
          <div class="wstep">
            <div class="wstep-num">2</div>
            <div class="wstep-text">
              <strong>Select Photos</strong>
              <span>Pick all photos at once from your gallery, then crop &amp; adjust each one</span>
            </div>
          </div>
          <div class="wstep">
            <div class="wstep-num">3</div>
            <div class="wstep-text">
              <strong>Add Details</strong>
              <span>Branch, class, event, date â€” shown in the header</span>
            </div>
          </div>
          <div class="wstep">
            <div class="wstep-num">4</div>
            <div class="wstep-text">
              <strong>Generate &amp; Download</strong>
              <span>Preview your sheet and download as a high-quality JPEG</span>
            </div>
          </div>
        </div>
      </div>
      <div class="slide-footer">
        <button class="btn-next" id="n0">Let's Begin â†’</button>
      </div>
    </div>

    <!-- SLIDE 1: GRID -->
    <div class="slide" id="s1">
      <div class="slide-inner">
        <div class="slide-eyebrow">Step 1 of 4</div>
        <div class="slide-title">Set your<br>grid size.</div>
        <div class="slide-sub">This determines how many photo slots your sheet will have.</div>

        <div class="grid-row">
          <div class="gf">
            <label>Columns</label>
            <input type="number" id="cols" value="4" min="1" max="10" inputmode="numeric">
          </div>
          <div class="gf">
            <label>Rows</label>
            <input type="number" id="rows" value="5" min="1" max="12" inputmode="numeric">
          </div>
        </div>
        <div class="slot-pill" id="slotPill">ğŸ“· &nbsp;20 photo slots</div>
      </div>
      <div class="slide-footer">
        <button class="btn-next" id="n1">Next â€” Select Photos â†’</button>
        <button class="btn-prev" id="p1">â† Back</button>
      </div>
    </div>

    <!-- SLIDE 2: PHOTOS -->
    <div class="slide" id="s2">
      <div class="slide-inner">
        <div class="slide-eyebrow">Step 2 of 4</div>
        <div class="slide-title">Select your<br>photos.</div>
        <div class="slide-sub">Choose all photos at once from your gallery. Tap any photo to crop &amp; adjust it.</div>

        <div class="upload-big" id="uploadZone">
          <input type="file" id="photoInput" multiple accept="image/*">
          <span class="ub-icon">ğŸ–¼</span>
          <p><strong>Tap to open gallery</strong><br>Select all <span id="uploadHint">20</span> photos at once Â· JPG, PNG, WEBP</p>
        </div>
        <div class="photo-count-bar" id="countBar"></div>
        <div class="photo-grid" id="photoGrid"></div>
      </div>
      <div class="slide-footer">
        <button class="btn-next" id="n2">Next â€” Add Details â†’</button>
        <button class="btn-prev" id="p2">â† Back</button>
      </div>
    </div>

    <!-- SLIDE 3: DETAILS -->
    <div class="slide" id="s3">
      <div class="slide-inner">
        <div class="slide-eyebrow">Step 3 of 4</div>
        <div class="slide-title">Sheet<br>details.</div>
        <div class="slide-sub">These appear in the header of your photo sheet.</div>

        <div class="df">
          <label>Branch / Campus</label>
          <input type="text" id="branchName" value="Whitefield Campus" autocomplete="off" placeholder="e.g. Whitefield Campus">
        </div>
        <div class="df-2">
          <div class="df">
            <label>Class / Grade</label>
            <input type="text" id="className" value="Grade 5 â€“ A" autocomplete="off">
          </div>
          <div class="df">
            <label>Academic Year</label>
            <input type="text" id="yearTerm" value="2024â€“25" autocomplete="off">
          </div>
        </div>
        <div class="df">
          <label>Event / Occasion <span style="color:var(--ink-3);font-weight:400;text-transform:none;letter-spacing:0">(optional)</span></label>
          <input type="text" id="eventName" placeholder="e.g. Annual Day, Sports Meet" autocomplete="off">
        </div>
        <div class="df-2">
          <div class="df">
            <label>Date <span style="color:var(--ink-3);font-weight:400;text-transform:none;letter-spacing:0">(optional)</span></label>
            <input type="text" id="eventDate" placeholder="15 Jan 2025" autocomplete="off">
          </div>
          <div class="df">
            <label>Page Size</label>
            <select id="pageSize">
              <option value="a4">A4</option>
              <option value="letter">Letter</option>
              <option value="a3">A3</option>
              <option value="square">Square</option>
            </select>
          </div>
        </div>
        <div class="df">
          <label>Orientation</label>
          <select id="pageOrientation">
            <option value="portrait">Portrait</option>
            <option value="landscape">Landscape</option>
          </select>
        </div>
      </div>
      <div class="slide-footer">
        <button class="btn-next" id="n3">Next â€” Generate â†’</button>
        <button class="btn-prev" id="p3">â† Back</button>
      </div>
    </div>

    <!-- SLIDE 4: CANVAS -->
    <div class="slide canvas-slide" id="s4">
      <div class="canvas-zone" id="canvasArea">
        <div class="canvas-placeholder" id="canvasPlaceholder">
          <div class="cp-icon">ğŸª·</div>
          <div class="cp-title">Your sheet will appear here</div>
          <div class="cp-sub">Tap Generate to build your frame sheet</div>
        </div>
        <div id="canvas-wrapper"><canvas id="main-canvas"></canvas></div>
      </div>
      <div class="slide-footer" style="background:var(--dark);border-top:1px solid #222">
        <button class="btn-gen" id="generateBtn">âœ¦ Generate Frame Sheet</button>
        <button class="btn-dl" id="downloadBtn">â¬‡ Download JPEG â€” Save Now</button>
        <button class="btn-prev" id="p4" style="color:rgba(255,255,255,.5);border-color:#333">â† Back to Details</button>
      </div>
    </div>

  </div><!-- slides-track -->
</div><!-- wizard-vp -->

<!-- FLOATING OBJECT TOOLBAR -->
<div class="obj-tb" id="objTb">
  <button class="ot-btn" id="otFront">â†‘ Front</button>
  <button class="ot-btn" id="otBack">â†“ Back</button>
  <div class="ot-sep"></div>
  <button class="ot-btn" id="otFlip">â†” Flip</button>
  <div class="ot-sep"></div>
  <button class="ot-btn red" id="otDel">âœ• Remove</button>
</div>

<!-- CROP MODAL -->
<div class="crop-modal" id="cropModal">
  <div class="crop-box">
    <div class="crop-hdr">
      <h3>Crop &amp; Adjust</h3>
      <button class="crop-x" id="cropX">âœ•</button>
    </div>
    <div class="crop-preview">
      <canvas id="crop-canvas" width="380" height="260"></canvas>
    </div>
    <div class="crop-ctrls">
      <div class="cr-row">
        <span class="cr-lbl">Zoom</span>
        <input type="range" class="cr-sl" id="crZoom" min="100" max="300" value="100">
        <span class="cr-val" id="crZoomV">1.0Ã—</span>
      </div>
      <div class="cr-row">
        <span class="cr-lbl">Pan X</span>
        <input type="range" class="cr-sl" id="crPanX" min="-100" max="100" value="0">
        <span class="cr-val" id="crPanXV">0</span>
      </div>
      <div class="cr-row">
        <span class="cr-lbl">Pan Y</span>
        <input type="range" class="cr-sl" id="crPanY" min="-100" max="100" value="0">
        <span class="cr-val" id="crPanYV">0</span>
      </div>
    </div>
    <div class="crop-acts">
      <button class="ca-no" id="cropCancel">Cancel</button>
      <button class="ca-ok" id="cropApply">Apply âœ“</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
const $ = id => document.getElementById(id);

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentSlide = 0;
let photoSlots   = []; // Array<{file, previewUrl, crop:{zoom,panX,panY}} | null>
let canvas       = null;
let cropIdx      = -1;
let cropImg      = null;

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, dur=2600){
  const el=$('toast'); el.textContent=msg; el.classList.add('on');
  clearTimeout(el._t); el._t=setTimeout(()=>el.classList.remove('on'),dur);
}

// â”€â”€ GRID HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getCols(){ return Math.max(1,+$('cols').value||4); }
function getRows(){ return Math.max(1,+$('rows').value||5); }
function getMax() { return getCols()*getRows(); }

function syncSlots(){
  const max=getMax();
  while(photoSlots.length<max) photoSlots.push(null);
  if(photoSlots.length>max) photoSlots=photoSlots.slice(0,max);
  $('slotPill').innerHTML=`ğŸ“· &nbsp;${max} photo slots`;
  $('uploadHint').textContent=max;
}
['cols','rows'].forEach(id=>$(id).addEventListener('input',()=>{syncSlots();renderGrid();}));

// â”€â”€ SLIDE NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goTo(n){
  currentSlide=n;
  const vw=window.innerWidth;
  $('track').style.transform=`translateX(-${n*vw}px)`;
  // On canvas slide reset track width
  $('track').style.width=(n===4)?`${5*vw}px`:`500%`;

  // Dots
  document.querySelectorAll('.step-dot').forEach((d,i)=>{
    d.classList.toggle('active',i===n);
    d.classList.toggle('done',i<n);
  });

  // Chrome buttons
  $('backToWizard').style.display = n===4 ? 'flex' : 'none';
  $('topDl').style.display = (n===4&&canvas) ? 'flex' : 'none';

  // Scroll slide to top
  const sl=$(`s${n}`); if(sl) sl.scrollTop=0;
}

// Fix track width on resize
window.addEventListener('resize',()=>{
  const vw=window.innerWidth;
  $('track').style.transition='none';
  $('track').style.transform=`translateX(-${currentSlide*vw}px)`;
  setTimeout(()=>$('track').style.transition='',50);
});

// Nav buttons
$('n0').addEventListener('click',()=>goTo(1));
$('n1').addEventListener('click',()=>goTo(2));
$('n2').addEventListener('click',()=>{
  if(!photoSlots.some(Boolean)){toast('Please add at least one photo first');return;}
  goTo(3);
});
$('n3').addEventListener('click',()=>goTo(4));
$('p1').addEventListener('click',()=>goTo(0));
$('p2').addEventListener('click',()=>goTo(1));
$('p3').addEventListener('click',()=>goTo(2));
$('p4').addEventListener('click',()=>goTo(3));
$('backToWizard').addEventListener('click',()=>goTo(3));

// â”€â”€ PHOTO UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('photoInput').addEventListener('change',e=>{
  const files=Array.from(e.target.files).filter(f=>f.type.startsWith('image/'));
  let added=0;
  files.forEach(f=>{
    const idx=photoSlots.indexOf(null);
    if(idx===-1)return;
    photoSlots[idx]={file:f,previewUrl:URL.createObjectURL(f),crop:{zoom:100,panX:0,panY:0}};
    added++;
  });
  const skipped=files.length-added;
  renderGrid();
  if(skipped>0) toast(`Added ${added} photo${added!==1?'s':''}. ${skipped} skipped â€” grid full.`);
  else if(added>0) toast(`${added} photo${added!==1?'s':''} added`);
  e.target.value='';
});

const uZone=$('uploadZone');
uZone.addEventListener('dragover',e=>{e.preventDefault();uZone.classList.add('over');});
uZone.addEventListener('dragleave',()=>uZone.classList.remove('over'));
uZone.addEventListener('drop',e=>{
  e.preventDefault();uZone.classList.remove('over');
  const files=Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('image/'));
  let added=0;
  files.forEach(f=>{
    const idx=photoSlots.indexOf(null);if(idx===-1)return;
    photoSlots[idx]={file:f,previewUrl:URL.createObjectURL(f),crop:{zoom:100,panX:0,panY:0}};added++;
  });
  renderGrid(); if(added) toast(`${added} photo${added!==1?'s':''} added`);
});

// â”€â”€ PHOTO GRID RENDERER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGrid(){
  const cols=getCols();
  const grid=$('photoGrid');
  const bar=$('countBar');
  const filled=photoSlots.filter(Boolean).length;
  const max=photoSlots.length;

  grid.style.gridTemplateColumns=`repeat(${Math.min(cols,5)},1fr)`;
  grid.style.display=max?'grid':'none';

  if(filled>0){
    bar.style.display='block';
    bar.textContent=`${filled} of ${max} photos selected`;
    bar.className='photo-count-bar'+(filled>=max?' full':'');
  } else {
    bar.style.display='none';
  }

  grid.innerHTML='';
  photoSlots.forEach((slot,idx)=>{
    const cell=document.createElement('div');
    cell.className='pcell'+(slot?'':' empty');

    if(slot){
      const badge=document.createElement('div');badge.className='pnum';badge.textContent=idx+1;
      const img=document.createElement('img');img.src=slot.previewUrl;
      const del=document.createElement('button');del.className='pdel';del.textContent='âœ•';
      del.addEventListener('click',e=>{e.stopPropagation();URL.revokeObjectURL(slot.previewUrl);photoSlots[idx]=null;renderGrid();});
      const cropTag=document.createElement('div');cropTag.className='crop-tag';cropTag.textContent='âœ‚ Tap to crop';
      cropTag.addEventListener('click',e=>{e.stopPropagation();openCrop(idx);});
      cell.addEventListener('click',()=>openCrop(idx));
      cell.append(badge,img,del,cropTag);
    } else {
      const inp=document.createElement('input');inp.type='file';inp.accept='image/*';
      inp.addEventListener('change',e=>{
        if(e.target.files[0]){
          URL.revokeObjectURL(photoSlots[idx]?.previewUrl);
          photoSlots[idx]={file:e.target.files[0],previewUrl:URL.createObjectURL(e.target.files[0]),crop:{zoom:100,panX:0,panY:0}};
          renderGrid();toast(`Slot ${idx+1} filled`);
        }
        e.target.value='';
      });
      const lbl=document.createElement('div');lbl.className='elabel';
      lbl.innerHTML=`<div style="font-size:20px;margin-bottom:3px">ï¼‹</div><div>Slot ${idx+1}</div>`;
      cell.append(inp,lbl);
    }
    grid.appendChild(cell);
  });
}

// â”€â”€ CROP MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCrop(idx){
  cropIdx=idx;
  const slot=photoSlots[idx]; if(!slot) return;
  $('crZoom').value=slot.crop.zoom; $('crZoomV').textContent=(slot.crop.zoom/100).toFixed(1)+'Ã—';
  $('crPanX').value=slot.crop.panX; $('crPanXV').textContent=slot.crop.panX;
  $('crPanY').value=slot.crop.panY; $('crPanYV').textContent=slot.crop.panY;
  cropImg=new Image();
  cropImg.onload=drawCrop;
  cropImg.src=slot.previewUrl;
  $('cropModal').classList.add('on');
}

function drawCrop(){
  const cv=$('crop-canvas'),ctx=cv.getContext('2d');
  const W=cv.width,H=cv.height;
  const zoom=+$('crZoom').value/100;
  const panX=+$('crPanX').value, panY=+$('crPanY').value;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#111';ctx.fillRect(0,0,W,H);
  if(!cropImg)return;
  const iw=cropImg.naturalWidth,ih=cropImg.naturalHeight;
  const base=Math.min(W/iw,H/ih);
  const dw=iw*base*zoom, dh=ih*base*zoom;
  ctx.drawImage(cropImg,(W-dw)/2+panX*1.5,(H-dh)/2+panY*1.5,dw,dh);
  // Rule of thirds
  ctx.strokeStyle='rgba(255,255,255,0.12)';ctx.lineWidth=1;
  [1/3,2/3].forEach(f=>{
    ctx.beginPath();ctx.moveTo(W*f,0);ctx.lineTo(W*f,H);
    ctx.moveTo(0,H*f);ctx.lineTo(W,H*f);ctx.stroke();
  });
}

['crZoom','crPanX','crPanY'].forEach(id=>{
  $(id).addEventListener('input',()=>{
    $('crZoomV').textContent=(+$('crZoom').value/100).toFixed(1)+'Ã—';
    $('crPanXV').textContent=$('crPanX').value;
    $('crPanYV').textContent=$('crPanY').value;
    drawCrop();
  });
});

$('cropApply').addEventListener('click',()=>{
  if(cropIdx<0)return;
  photoSlots[cropIdx].crop={zoom:+$('crZoom').value,panX:+$('crPanX').value,panY:+$('crPanY').value};
  $('cropModal').classList.remove('on');
  renderGrid(); toast('Crop applied âœ“');
});
$('cropX').addEventListener('click',()=>$('cropModal').classList.remove('on'));
$('cropCancel').addEventListener('click',()=>$('cropModal').classList.remove('on'));

// â”€â”€ PAGE SIZE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SIZES={a4:[210,297],letter:[216,279],a3:[297,420],square:[297,297]};
function getPagePx(){
  const dpi=150; let[w,h]=SIZES[$('pageSize').value];
  if($('pageOrientation').value==='landscape')[w,h]=[h,w];
  const f=dpi/25.4; return[Math.round(w*f),Math.round(h*f)];
}

// â”€â”€ GENERATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateSheet(){
  const filled=photoSlots.filter(Boolean);
  if(!filled.length){toast('Please add at least one photo first');return;}
  $('generateBtn').textContent='â³ Generatingâ€¦';$('generateBtn').disabled=true;

  const[W,H]=getPagePx();
  const cols=getCols(),rows=getRows(),pad=4,locked=true;

  $('canvas-wrapper').classList.add('visible');
  $('canvasPlaceholder').style.display='none';

  if(canvas){canvas.dispose();const old=$('main-canvas');if(old)old.remove();}
  const c=document.createElement('canvas');c.id='main-canvas';
  $('canvas-wrapper').appendChild(c);

  const area=$('canvasArea');
  const scale=Math.min(1,(area.clientWidth-32)/W,(area.clientHeight-32)/H);
  canvas=new fabric.Canvas('main-canvas',{width:W,height:H,backgroundColor:'#FFFFFF',selection:true,preserveObjectStacking:true,allowTouchScrolling:false});
  canvas.setZoom(scale);canvas.setWidth(W*scale);canvas.setHeight(H*scale);
  $('canvas-wrapper').style.cssText=`width:${W*scale}px;height:${H*scale}px;`;

  // HEADER
  const hh=H*0.10, stripe=Math.max(3,Math.round(hh*0.045));
  const branch=$('branchName').value||'Main Campus';
  const cls=$('className').value||''; const yr=$('yearTerm').value||'';
  const evt=$('eventName').value||''; const dt=$('eventDate').value||'';
  const subLine=[cls,yr].filter(Boolean).join('   Â·   ');
  const evtLine=[evt,dt].filter(Boolean).join('   Â·   ');
  const lk={selectable:!locked,evented:!locked,lockMovementX:locked,lockMovementY:locked,hasControls:!locked,hasBorders:!locked};

  canvas.add(
    new fabric.Rect({left:0,top:0,width:W,height:hh,fill:'#FFFFFF',...lk}),
    new fabric.Rect({left:0,top:0,width:W,height:stripe,fill:'#C2187E',selectable:false,evented:false}),
    new fabric.Text('Samsidh School',{left:W/2,top:hh*0.10,originX:'center',fontFamily:'Georgia,serif',fontSize:Math.round(hh*0.31),fill:'#C2187E',fontWeight:'bold',...lk}),
    new fabric.Text(branch,{left:W/2,top:hh*0.48,originX:'center',fontFamily:'Arial,sans-serif',fontSize:Math.round(hh*0.185),fill:'#222',fontWeight:'700',...lk}),
    new fabric.Text(subLine,{left:W/2,top:hh*0.70,originX:'center',fontFamily:'Arial,sans-serif',fontSize:Math.round(hh*0.125),fill:'#555',...lk}),
  );
  if(evtLine) canvas.add(new fabric.Text(evtLine,{left:W/2,top:hh*0.84,originX:'center',fontFamily:'Arial,sans-serif',fontSize:Math.round(hh*0.115),fill:'#888',...lk}));
  canvas.add(new fabric.Rect({left:0,top:hh-stripe,width:W,height:stripe,fill:'#C2187E',selectable:false,evented:false}));

  // PHOTO GRID
  const gridTop=hh+pad,gridW=W-pad*2,gridH=H-gridTop-pad;
  const cellW=(gridW-pad*(cols-1))/cols, cellH=(gridH-pad*(rows-1))/rows;
  const cornerSz=window.innerWidth<768?20:10;

  const loadImg=slot=>new Promise(res=>{
    const url=URL.createObjectURL(slot.file);
    fabric.Image.fromURL(url,img=>{setTimeout(()=>URL.revokeObjectURL(url),1500);res(img);});
  });

  for(let i=0;i<Math.min(photoSlots.length,cols*rows);i++){
    const slot=photoSlots[i]; if(!slot)continue;
    const img=await loadImg(slot);
    const col=i%cols,row=Math.floor(i/cols);
    const x=pad+col*(cellW+pad),y=gridTop+row*(cellH+pad);
    const iw=img.width,ih=img.height;
    const zoom=slot.crop.zoom/100;
    const scBase=Math.max(cellW/iw,cellH/ih), sc=scBase*zoom;
    const visW=cellW/sc, visH=cellH/sc;
    const cx=iw/2-slot.crop.panX*(iw/200);
    const cy=ih/2-slot.crop.panY*(ih/200);
    img.set({
      left:x,top:y,scaleX:sc,scaleY:sc,
      cropX:Math.max(0,Math.min(iw-visW,cx-visW/2)),
      cropY:Math.max(0,Math.min(ih-visH,cy-visH/2)),
      width:Math.min(iw,visW),height:Math.min(ih,visH),
      lockUniScaling:true,
      cornerSize:cornerSz,touchCornerSize:26,
      transparentCorners:false,
      cornerColor:'#C2187E',cornerStrokeColor:'#fff',
      borderColor:'#C2187E',borderScaleFactor:1.5,
    });
    canvas.add(img);
  }

  canvas.renderAll();
  setupCanvasEvents();

  $('generateBtn').textContent='âœ¦ Regenerate';$('generateBtn').disabled=false;
  $('downloadBtn').style.display='flex';
  $('topDl').style.display='flex';
  toast('Sheet ready! Tap photos to adjust. Download below.');
}

$('generateBtn').addEventListener('click',generateSheet);

// â”€â”€ CANVAS EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupCanvasEvents(){
  canvas.on('selection:created',()=>$('objTb').classList.add('on'));
  canvas.on('selection:updated',()=>$('objTb').classList.add('on'));
  canvas.on('selection:cleared',()=>$('objTb').classList.remove('on'));
}
$('otDel').addEventListener('click',()=>{const o=canvas?.getActiveObject();if(o){canvas.remove(o);canvas.renderAll();$('objTb').classList.remove('on');}});
$('otFront').addEventListener('click',()=>{const o=canvas?.getActiveObject();if(o){canvas.bringToFront(o);canvas.renderAll();}});
$('otBack').addEventListener('click',()=>{const o=canvas?.getActiveObject();if(o){canvas.sendToBack(o);canvas.renderAll();}});
$('otFlip').addEventListener('click',()=>{const o=canvas?.getActiveObject();if(o){o.set('flipX',!o.flipX);canvas.renderAll();}});

// â”€â”€ DOWNLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doDownload(){
  if(!canvas){toast('Generate a sheet first');return;}
  const[W,H]=getPagePx();
  canvas.setZoom(1);canvas.setWidth(W);canvas.setHeight(H);canvas.renderAll();
  const url=canvas.toDataURL({format:'jpeg',quality:0.95});
  const area=$('canvasArea');
  const scale=Math.min(1,(area.clientWidth-32)/W,(area.clientHeight-32)/H);
  canvas.setZoom(scale);canvas.setWidth(W*scale);canvas.setHeight(H*scale);canvas.renderAll();
  const a=document.createElement('a');
  a.href=url;
  a.download=('Samsidh_'+($('branchName').value||'Sheet')).replace(/\s+/g,'_')+'.jpg';
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  toast('â¬‡ Saved to Downloads!');
}
$('downloadBtn').addEventListener('click',doDownload);
$('topDl').addEventListener('click',doDownload);

// â”€â”€ KEYBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown',e=>{
  if(!canvas||e.target.matches('input,textarea,select'))return;
  if(e.key==='Delete'||e.key==='Backspace'){const o=canvas.getActiveObject();if(o){canvas.remove(o);canvas.renderAll();}}
});

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
syncSlots();
renderGrid();
goTo(0);
})();
</script>
</body>
</html>
