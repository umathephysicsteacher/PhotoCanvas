<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>School Photo Sheet Generator</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --ink: #1a1a2e;
    --paper: #f5f0e8;
    --accent: #c4692a;
    --accent2: #2a6bc4;
    --mid: #8a8a9a;
    --border: #d8d0c0;
    --white: #ffffff;
    --shadow: 0 4px 24px rgba(26,26,46,0.12);
  }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--paper);
    color: var(--ink);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  header {
    background: var(--ink);
    color: var(--white);
    padding: 18px 32px;
    display: flex;
    align-items: center;
    gap: 16px;
    border-bottom: 3px solid var(--accent);
  }

  header .logo {
    font-family: 'Playfair Display', serif;
    font-size: 22px;
    font-weight: 700;
    letter-spacing: 0.02em;
  }

  header .logo span { color: var(--accent); }

  header p {
    font-size: 12px;
    color: rgba(255,255,255,0.5);
    font-weight: 300;
    margin-left: auto;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .app {
    display: flex;
    flex: 1;
    gap: 0;
    overflow: hidden;
  }

  /* SIDEBAR */
  .sidebar {
    width: 300px;
    min-width: 280px;
    background: var(--white);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    box-shadow: 2px 0 12px rgba(26,26,46,0.06);
  }

  .sidebar-section {
    padding: 20px;
    border-bottom: 1px solid var(--border);
  }

  .sidebar-section h3 {
    font-family: 'Playfair Display', serif;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--mid);
    margin-bottom: 14px;
  }

  label.field-label {
    display: block;
    font-size: 11px;
    font-weight: 500;
    color: var(--mid);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 5px;
  }

  input[type="text"], input[type="number"], select {
    width: 100%;
    padding: 9px 12px;
    border: 1.5px solid var(--border);
    border-radius: 6px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    color: var(--ink);
    background: var(--paper);
    margin-bottom: 10px;
    transition: border-color 0.2s;
    outline: none;
  }

  input[type="text"]:focus, input[type="number"]:focus, select:focus {
    border-color: var(--accent2);
  }

  .checkbox-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }

  .checkbox-row input[type="checkbox"] { accent-color: var(--accent); width: 15px; height: 15px; }
  .checkbox-row label { font-size: 13px; color: var(--ink); }

  /* Upload zone */
  .upload-zone {
    border: 2px dashed var(--border);
    border-radius: 10px;
    padding: 24px 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--paper);
    position: relative;
  }

  .upload-zone:hover, .upload-zone.drag-over {
    border-color: var(--accent2);
    background: #eef4ff;
  }

  .upload-zone input[type="file"] {
    position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
  }

  .upload-zone .upload-icon {
    font-size: 28px;
    display: block;
    margin-bottom: 8px;
  }

  .upload-zone p {
    font-size: 12px;
    color: var(--mid);
    line-height: 1.5;
  }

  .upload-zone strong { color: var(--accent2); font-weight: 600; }

  /* Thumbnail list */
  #thumbnail-list {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 10px;
  }

  .thumb-item {
    position: relative;
    border-radius: 6px;
    overflow: hidden;
    border: 2px solid var(--border);
    cursor: grab;
    transition: border-color 0.2s, transform 0.1s;
    background: #eee;
  }

  .thumb-item:hover { border-color: var(--accent2); transform: scale(1.02); }
  .thumb-item.dragging { opacity: 0.4; }

  .thumb-item img {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
    display: block;
  }

  .thumb-item .thumb-remove {
    position: absolute;
    top: 3px; right: 3px;
    background: rgba(196,105,42,0.85);
    color: white;
    border: none;
    width: 20px; height: 20px;
    border-radius: 50%;
    font-size: 11px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .thumb-item:hover .thumb-remove { opacity: 1; }

  .thumb-item .thumb-name {
    font-size: 9px;
    color: white;
    background: rgba(0,0,0,0.55);
    position: absolute;
    bottom: 0; left: 0; right: 0;
    padding: 2px 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    padding: 10px 16px;
    border: none;
    border-radius: 7px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.18s;
    letter-spacing: 0.02em;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
    box-shadow: 0 2px 8px rgba(196,105,42,0.35);
  }

  .btn-primary:hover { background: #b05a22; transform: translateY(-1px); }
  .btn-primary:active { transform: translateY(0); }

  .btn-secondary {
    background: var(--paper);
    color: var(--ink);
    border: 1.5px solid var(--border);
  }

  .btn-secondary:hover { border-color: var(--accent2); background: #eef4ff; }

  .btn-success {
    background: #2a7a4c;
    color: white;
    box-shadow: 0 2px 8px rgba(42,122,76,0.3);
  }

  .btn-success:hover { background: #226040; }

  .btn-danger {
    background: transparent;
    color: #c44040;
    border: 1.5px solid #e0b0b0;
    padding: 7px 12px;
  }

  .btn-danger:hover { background: #fdf0f0; }

  .btn-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
  }

  .btn-row {
    display: flex;
    gap: 8px;
  }

  .btn-row .btn { flex: 1; justify-content: center; }

  /* Canvas area */
  .canvas-area {
    flex: 1;
    background: #2c2c3a;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 40px;
    overflow: auto;
    position: relative;
  }

  .canvas-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: rgba(255,255,255,0.25);
    text-align: center;
    height: 100%;
    width: 100%;
    position: absolute;
    inset: 0;
    pointer-events: none;
  }

  .canvas-placeholder .ph-icon { font-size: 56px; margin-bottom: 16px; }
  .canvas-placeholder p { font-size: 15px; font-weight: 300; letter-spacing: 0.05em; }
  .canvas-placeholder small { font-size: 12px; opacity: 0.6; margin-top: 6px; }

  #canvas-wrapper {
    display: none;
    box-shadow: 0 8px 48px rgba(0,0,0,0.5);
    position: relative;
    background: white;
  }

  #canvas-wrapper.visible { display: block; }

  #main-canvas {
    display: block;
  }

  /* Toolbar above canvas */
  .canvas-toolbar {
    position: absolute;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    display: none;
    background: rgba(26,26,46,0.9);
    backdrop-filter: blur(8px);
    border-radius: 8px;
    padding: 7px 12px;
    gap: 6px;
    align-items: center;
    border: 1px solid rgba(255,255,255,0.1);
    z-index: 10;
    white-space: nowrap;
  }

  .canvas-toolbar.visible { display: flex; }

  .canvas-toolbar .btn {
    padding: 6px 12px;
    font-size: 12px;
  }

  .canvas-toolbar .sep {
    width: 1px;
    height: 24px;
    background: rgba(255,255,255,0.15);
    margin: 0 2px;
  }

  /* Status bar */
  .status-bar {
    background: var(--ink);
    color: rgba(255,255,255,0.5);
    font-size: 11px;
    padding: 6px 20px;
    display: flex;
    gap: 16px;
    letter-spacing: 0.04em;
  }

  .status-bar span { color: rgba(255,255,255,0.8); }

  /* toast */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--ink);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 500;
    border-left: 3px solid var(--accent);
    box-shadow: var(--shadow);
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s;
    z-index: 9999;
    pointer-events: none;
  }

  .toast.show { transform: translateY(0); opacity: 1; }

  /* Range slider */
  input[type="range"] {
    width: 100%;
    accent-color: var(--accent2);
    margin: 4px 0 10px;
  }

  .range-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 4px;
  }

  .range-row label { font-size: 12px; color: var(--mid); min-width: 90px; }
  .range-row span { font-size: 12px; font-weight: 600; min-width: 32px; text-align: right; }

  /* Color input */
  input[type="color"] {
    width: 40px; height: 30px;
    border: 1.5px solid var(--border);
    border-radius: 5px;
    padding: 2px;
    cursor: pointer;
    background: none;
  }

  .color-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
  }

  .color-row label { font-size: 12px; color: var(--mid); flex: 1; }

</style>
</head>
<body>

<header>
  <div class="logo">Photo<span>Sheet</span> Studio</div>
  <p>Interactive School Photo Sheet Generator</p>
</header>

<div class="app">
  <!-- SIDEBAR -->
  <div class="sidebar">

    <!-- School Info -->
    <div class="sidebar-section">
      <h3>School Details</h3>
      <label class="field-label">School Name</label>
      <input type="text" id="schoolName" value="Springfield Elementary" placeholder="School name">
      <label class="field-label">Class / Grade</label>
      <input type="text" id="className" value="Grade 5 ‚Äì Class A" placeholder="Class or grade">
      <label class="field-label">Year / Term</label>
      <input type="text" id="yearTerm" value="2024‚Äì2025" placeholder="Year or term">
      <div class="checkbox-row">
        <input type="checkbox" id="lockHeader" checked>
        <label for="lockHeader">Lock header (prevent moving)</label>
      </div>
    </div>

    <!-- Page Setup -->
    <div class="sidebar-section">
      <h3>Page Setup</h3>
      <label class="field-label">Page Size</label>
      <select id="pageSize">
        <option value="a4">A4 (210 √ó 297 mm)</option>
        <option value="letter">US Letter (216 √ó 279 mm)</option>
        <option value="a3">A3 (297 √ó 420 mm)</option>
        <option value="square">Square (297 √ó 297 mm)</option>
      </select>
      <label class="field-label">Orientation</label>
      <select id="pageOrientation">
        <option value="portrait">Portrait</option>
        <option value="landscape">Landscape</option>
      </select>
      <div class="range-row">
        <label>Scale (DPI)</label>
        <span id="dpiVal">150</span>
      </div>
      <input type="range" id="dpiSlider" min="72" max="300" step="36" value="150">

      <div class="color-row">
        <label>Background color</label>
        <input type="color" id="bgColor" value="#ffffff">
      </div>
    </div>

    <!-- Photos -->
    <div class="sidebar-section">
      <h3>Photos</h3>
      <div class="upload-zone" id="uploadZone">
        <input type="file" id="photoInput" multiple accept="image/*">
        <span class="upload-icon">üìÅ</span>
        <p><strong>Click or drag</strong> to upload photos<br>JPG, PNG, WEBP supported</p>
      </div>
      <div id="thumbnail-list"></div>
    </div>

    <!-- Layout -->
    <div class="sidebar-section">
      <h3>Auto Layout</h3>
      <label class="field-label">Columns</label>
      <input type="number" id="cols" value="4" min="1" max="10">
      <label class="field-label">Rows</label>
      <input type="number" id="rows" value="5" min="1" max="12">
      <div class="range-row">
        <label>Photo padding</label>
        <span id="paddingVal">10</span>px
      </div>
      <input type="range" id="paddingSlider" min="0" max="30" value="10">
    </div>

    <!-- Actions -->
    <div class="btn-group">
      <button class="btn btn-primary" id="generateBtn" style="justify-content:center;font-size:14px;padding:13px;">
        ‚ú¶ Generate Photo Sheet
      </button>
      <div class="btn-row">
        <button class="btn btn-secondary" id="shuffleBtn">üîÄ Shuffle</button>
        <button class="btn btn-secondary" id="clearCanvasBtn">üóë Clear</button>
      </div>
      <button class="btn btn-success" id="downloadBtn" style="justify-content:center;display:none;">
        ‚¨á Download JPEG
      </button>
    </div>

  </div>

  <!-- CANVAS AREA -->
  <div class="canvas-area" id="canvasArea">
    <div class="canvas-placeholder" id="canvasPlaceholder">
      <div class="ph-icon">üñº</div>
      <p>Upload photos and click Generate</p>
      <small>Your interactive photo sheet will appear here</small>
    </div>

    <div class="canvas-toolbar" id="canvasToolbar">
      <button class="btn btn-secondary" id="tbDeleteBtn" title="Delete selected">üóë Delete</button>
      <button class="btn btn-secondary" id="tbBringFront">‚Üë Front</button>
      <button class="btn btn-secondary" id="tbSendBack">‚Üì Back</button>
      <div class="sep"></div>
      <button class="btn btn-secondary" id="tbFlipH">‚Üî Flip H</button>
      <button class="btn btn-secondary" id="tbFlipV">‚Üï Flip V</button>
      <div class="sep"></div>
      <span style="color:rgba(255,255,255,0.4);font-size:12px;" id="tbInfo">No selection</span>
    </div>

    <div id="canvas-wrapper">
      <canvas id="main-canvas"></canvas>
    </div>
  </div>
</div>

<div class="status-bar" id="statusBar">
  <span id="statusPhotos">0 photos loaded</span>
  <span id="statusCanvas">No canvas</span>
  <span id="statusSelected">Nothing selected</span>
</div>

<div class="toast" id="toast"></div>

<script>
(function() {
  const $ = id => document.getElementById(id);

  let canvas = null;
  let photoFiles = [];
  let photoOrder = []; // indices into photoFiles

  // ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function toast(msg, duration = 2500) {
    const el = $('toast');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), duration);
  }

  // ‚îÄ‚îÄ‚îÄ File uploads ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  $('photoInput').addEventListener('change', e => handleFiles(e.target.files));

  const uploadZone = $('uploadZone');
  uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
  uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
  uploadZone.addEventListener('drop', e => {
    e.preventDefault();
    uploadZone.classList.remove('drag-over');
    handleFiles(e.dataTransfer.files);
  });

  function handleFiles(files) {
    const arr = Array.from(files).filter(f => f.type.startsWith('image/'));
    arr.forEach(f => {
      photoFiles.push(f);
      photoOrder.push(photoFiles.length - 1);
    });
    renderThumbs();
    updateStatus();
    toast(`${arr.length} photo(s) added`);
  }

  function renderThumbs() {
    const list = $('thumbnail-list');
    list.innerHTML = '';
    photoOrder.forEach((idx, pos) => {
      const f = photoFiles[idx];
      const url = URL.createObjectURL(f);
      const div = document.createElement('div');
      div.className = 'thumb-item';
      div.draggable = true;
      div.dataset.pos = pos;

      const img = document.createElement('img');
      img.src = url;
      img.onload = () => URL.revokeObjectURL(url);

      const nameEl = document.createElement('div');
      nameEl.className = 'thumb-name';
      nameEl.textContent = f.name.replace(/\.[^.]+$/, '');

      const btn = document.createElement('button');
      btn.className = 'thumb-remove';
      btn.innerHTML = '‚úï';
      btn.onclick = (e) => { e.stopPropagation(); removePhoto(pos); };

      div.appendChild(img);
      div.appendChild(nameEl);
      div.appendChild(btn);
      list.appendChild(div);

      // Drag to reorder
      div.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', pos);
        div.classList.add('dragging');
      });
      div.addEventListener('dragend', () => div.classList.remove('dragging'));
      div.addEventListener('dragover', e => e.preventDefault());
      div.addEventListener('drop', e => {
        e.preventDefault();
        const from = parseInt(e.dataTransfer.getData('text/plain'));
        const to = parseInt(div.dataset.pos);
        if (from !== to) {
          const tmp = photoOrder[from];
          photoOrder.splice(from, 1);
          photoOrder.splice(to, 0, tmp);
          renderThumbs();
        }
      });
    });
  }

  function removePhoto(pos) {
    photoOrder.splice(pos, 1);
    renderThumbs();
    updateStatus();
  }

  // ‚îÄ‚îÄ‚îÄ Sliders ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  $('dpiSlider').addEventListener('input', function() { $('dpiVal').textContent = this.value; });
  $('paddingSlider').addEventListener('input', function() { $('paddingVal').textContent = this.value; });
  $('bgColor').addEventListener('input', function() {
    if (canvas) canvas.backgroundColor = this.value, canvas.renderAll();
  });

  // ‚îÄ‚îÄ‚îÄ Page dimensions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const PAGE_SIZES = {
    a4:     [210, 297],
    letter: [216, 279],
    a3:     [297, 420],
    square: [297, 297],
  };

  function getPagePx() {
    const dpi = parseInt($('dpiSlider').value);
    const size = PAGE_SIZES[$('pageSize').value];
    const orientation = $('pageOrientation').value;
    let [w, h] = size;
    if (orientation === 'landscape') [w, h] = [h, w];
    const mmToPx = dpi / 25.4;
    return [Math.round(w * mmToPx), Math.round(h * mmToPx)];
  }

  // ‚îÄ‚îÄ‚îÄ Generate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  $('generateBtn').addEventListener('click', generateSheet);

  async function generateSheet() {
    if (photoFiles.length === 0) { toast('Please upload photos first!'); return; }

    const [W, H] = getPagePx();
    const cols = Math.max(1, parseInt($('cols').value) || 4);
    const rows = Math.max(1, parseInt($('rows').value) || 5);
    const padding = parseInt($('paddingSlider').value);
    const headerLocked = $('lockHeader').checked;

    // Init / reinit canvas
    const wrapper = $('canvas-wrapper');
    wrapper.classList.add('visible');
    $('canvasPlaceholder').style.display = 'none';

    if (canvas) {
      canvas.dispose();
      const old = $('main-canvas');
      old.parentNode.removeChild(old);
    }
    const newCanv = document.createElement('canvas');
    newCanv.id = 'main-canvas';
    wrapper.appendChild(newCanv);

    // Scale canvas to fit viewport
    const maxW = $('canvasArea').clientWidth - 80;
    const maxH = $('canvasArea').clientHeight - 80;
    const scale = Math.min(1, maxW / W, maxH / H);

    canvas = new fabric.Canvas('main-canvas', {
      width: W,
      height: H,
      backgroundColor: $('bgColor').value,
      selection: true,
      preserveObjectStacking: true,
    });

    // Visual zoom to fit
    canvas.setZoom(scale);
    canvas.setWidth(W * scale);
    canvas.setHeight(H * scale);
    wrapper.style.width = (W * scale) + 'px';
    wrapper.style.height = (H * scale) + 'px';

    // ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const headerH = H * 0.09;

    // Background rect for header
    const headerBg = new fabric.Rect({
      left: 0, top: 0,
      width: W, height: headerH,
      fill: '#1a1a2e',
      selectable: !headerLocked,
      evented: !headerLocked,
      lockMovementX: headerLocked,
      lockMovementY: headerLocked,
      hasControls: !headerLocked,
      hasBorders: !headerLocked,
    });

    const schoolName = new fabric.Text($('schoolName').value || 'School Name', {
      left: W / 2,
      top: headerH * 0.22,
      originX: 'center',
      fontFamily: 'Georgia, serif',
      fontSize: Math.round(headerH * 0.32),
      fill: '#ffffff',
      fontWeight: 'bold',
      selectable: !headerLocked,
      evented: !headerLocked,
      lockMovementX: headerLocked,
      lockMovementY: headerLocked,
      hasControls: !headerLocked,
    });

    const subLine = ($('className').value || 'Class') + '  ‚Ä¢  ' + ($('yearTerm').value || '');
    const subText = new fabric.Text(subLine, {
      left: W / 2,
      top: headerH * 0.62,
      originX: 'center',
      fontFamily: 'Georgia, serif',
      fontSize: Math.round(headerH * 0.18),
      fill: 'rgba(255,255,255,0.7)',
      selectable: !headerLocked,
      evented: !headerLocked,
      lockMovementX: headerLocked,
      lockMovementY: headerLocked,
      hasControls: !headerLocked,
    });

    // Accent line
    const accentLine = new fabric.Rect({
      left: 0, top: headerH - 4,
      width: W, height: 4,
      fill: '#c4692a',
      selectable: false,
      evented: false,
    });

    canvas.add(headerBg, schoolName, subText, accentLine);

    // ‚îÄ‚îÄ Photos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const gridTop = headerH + padding * 2;
    const gridH = H - gridTop - padding;
    const gridW = W - padding * 2;

    const cellW = (gridW - padding * (cols - 1)) / cols;
    const cellH = (gridH - padding * (rows - 1)) / rows;

    const loadImage = (file) => new Promise((resolve) => {
      const url = URL.createObjectURL(file);
      fabric.Image.fromURL(url, (img) => {
        URL.revokeObjectURL(url);
        resolve(img);
      }, { crossOrigin: 'anonymous' });
    });

    const toPlace = photoOrder.slice(0, cols * rows);

    for (let i = 0; i < toPlace.length; i++) {
      const file = photoFiles[toPlace[i]];
      const col = i % cols;
      const row = Math.floor(i / cols);
      const x = padding + col * (cellW + padding);
      const y = gridTop + row * (cellH + padding);

      const img = await loadImage(file);

      // Fit image preserving aspect ratio (object-fit: contain)
      const iw = img.width, ih = img.height;
      const scaleX = cellW / iw;
      const scaleY = cellH / ih;
      const sc = Math.min(scaleX, scaleY);

      const fitW = iw * sc;
      const fitH = ih * sc;
      const ox = x + (cellW - fitW) / 2;
      const oy = y + (cellH - fitH) / 2;

      img.set({
        left: ox,
        top: oy,
        scaleX: sc,
        scaleY: sc,
        lockUniScaling: true,
        cornerSize: 10,
        transparentCorners: false,
        cornerColor: '#2a6bc4',
        cornerStrokeColor: '#fff',
        borderColor: '#2a6bc4',
        borderScaleFactor: 2,
      });

      // Preserve aspect ratio on resize
      img.on('scaling', function(opt) {
        const obj = this;
        if (opt.transform) {
          const corner = opt.transform.corner;
          if (corner && ['ml','mr','mt','mb'].includes(corner)) {
            // Force uniform scale
          }
        }
        const newScaleX = obj.scaleX;
        const ratio = iw / ih;
        obj.scaleY = newScaleX / ratio * (ih / iw) * obj.scaleX / newScaleX;
      });

      canvas.add(img);
    }

    canvas.renderAll();
    setupCanvasEvents();
    $('canvasToolbar').classList.add('visible');
    $('downloadBtn').style.display = 'flex';
    $('downloadBtn').style.justifyContent = 'center';
    updateStatus();
    toast('‚ú¶ Photo sheet generated! Drag and resize freely.');
  }

  // ‚îÄ‚îÄ‚îÄ Canvas events ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function setupCanvasEvents() {
    canvas.on('selection:created', updateSelectionUI);
    canvas.on('selection:updated', updateSelectionUI);
    canvas.on('selection:cleared', () => {
      $('tbInfo').textContent = 'No selection';
      $('statusSelected').textContent = 'Nothing selected';
    });
    canvas.on('object:modified', () => canvas.renderAll());
  }

  function updateSelectionUI() {
    const obj = canvas.getActiveObject();
    if (!obj) return;
    const type = obj.type === 'image' ? 'üì∑ Photo' : 'üî§ Text';
    const w = Math.round(obj.getScaledWidth());
    const h = Math.round(obj.getScaledHeight());
    $('tbInfo').textContent = `${type}  ${w}√ó${h}px`;
    $('statusSelected').textContent = `Selected: ${type} (${w}√ó${h}px)`;
  }

  // ‚îÄ‚îÄ‚îÄ Toolbar buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  $('tbDeleteBtn').addEventListener('click', () => {
    const obj = canvas.getActiveObject();
    if (obj) { canvas.remove(obj); canvas.renderAll(); toast('Deleted'); }
  });

  $('tbBringFront').addEventListener('click', () => {
    const obj = canvas.getActiveObject();
    if (obj) { canvas.bringToFront(obj); canvas.renderAll(); }
  });

  $('tbSendBack').addEventListener('click', () => {
    const obj = canvas.getActiveObject();
    if (obj) { canvas.sendToBack(obj); canvas.renderAll(); }
  });

  $('tbFlipH').addEventListener('click', () => {
    const obj = canvas.getActiveObject();
    if (obj) { obj.set('flipX', !obj.flipX); canvas.renderAll(); }
  });

  $('tbFlipV').addEventListener('click', () => {
    const obj = canvas.getActiveObject();
    if (obj) { obj.set('flipY', !obj.flipY); canvas.renderAll(); }
  });

  // ‚îÄ‚îÄ‚îÄ Shuffle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  $('shuffleBtn').addEventListener('click', () => {
    for (let i = photoOrder.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [photoOrder[i], photoOrder[j]] = [photoOrder[j], photoOrder[i]];
    }
    renderThumbs();
    if (canvas) generateSheet();
    toast('üîÄ Photos shuffled');
  });

  // ‚îÄ‚îÄ‚îÄ Clear ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  $('clearCanvasBtn').addEventListener('click', () => {
    if (canvas) {
      canvas.dispose();
      canvas = null;
      const old = $('main-canvas');
      if (old) old.parentNode.removeChild(old);
      const newCanv = document.createElement('canvas');
      newCanv.id = 'main-canvas';
      $('canvas-wrapper').appendChild(newCanv);
      $('canvas-wrapper').classList.remove('visible');
    }
    $('canvasPlaceholder').style.display = '';
    $('canvasToolbar').classList.remove('visible');
    $('downloadBtn').style.display = 'none';
    photoFiles = []; photoOrder = [];
    renderThumbs();
    updateStatus();
    toast('Canvas cleared');
  });

  // ‚îÄ‚îÄ‚îÄ Download ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  $('downloadBtn').addEventListener('click', () => {
    if (!canvas) return;

    const quality = 0.94;
    // Export at full resolution (reset zoom)
    const currentZoom = canvas.getZoom();
    canvas.setZoom(1);
    const [W, H] = getPagePx();
    canvas.setWidth(W);
    canvas.setHeight(H);
    canvas.renderAll();

    const dataURL = canvas.toDataURL({ format: 'jpeg', quality });

    // Restore zoom
    const maxW = $('canvasArea').clientWidth - 80;
    const maxH = $('canvasArea').clientHeight - 80;
    const scale = Math.min(1, maxW / W, maxH / H);
    canvas.setZoom(scale);
    canvas.setWidth(W * scale);
    canvas.setHeight(H * scale);
    canvas.renderAll();

    const a = document.createElement('a');
    const school = ($('schoolName').value || 'photosheet').replace(/\s+/g, '_');
    a.download = school + '_photo_sheet.jpg';
    a.href = dataURL;
    a.click();
    toast('‚¨á Downloading JPEG‚Ä¶');
  });

  // ‚îÄ‚îÄ‚îÄ Status ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function updateStatus() {
    $('statusPhotos').textContent = `${photoFiles.length} photo(s) loaded`;
    if (canvas) {
      const [W, H] = getPagePx();
      $('statusCanvas').textContent = `Canvas: ${W}√ó${H}px`;
    } else {
      $('statusCanvas').textContent = 'No canvas';
    }
  }

  // ‚îÄ‚îÄ‚îÄ Keyboard shortcuts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.addEventListener('keydown', e => {
    if (!canvas) return;
    if ((e.key === 'Delete' || e.key === 'Backspace') && !e.target.matches('input,textarea')) {
      const obj = canvas.getActiveObject();
      if (obj) { canvas.remove(obj); canvas.renderAll(); }
    }
  });

  updateStatus();
})();
</script>
</body>
</html>
